#!/bin/bash

set -e

builddir="@builddir@"
srcdir="@srcdir@"
logdir="$builddir/logs"

# optional argument --small to use small data file
[ $# -eq 1 -a "$1" == "--small" ] && datafile=small || datafile=big

# one benchmark may have different flavours
# they differ only in the suffix that starts with dash
stem_bench() {
    egrep -o '^[0-9a-z_]+'
}

# a few different benchmarks may share the same data
# everything up to the first underscore is the data stem
stem_data() {
    egrep -o '^[0-9a-z]+'
}

run() {
    engine="$1"
    prog="$2"
    data="$builddir/data/$(echo $prog | stem_data)/$datafile"
    log="$logdir/$engine/$prog"
    mkdir -p "$logdir/$engine"
    "$builddir/bin/$engine/$prog" < "$data" >"$log"
}

# build
make -j$(nproc)

rm -rf "$logdir" && mkdir -p "$logdir"

# select benchmarks
progs="$(find $builddir/bin -type f | fgrep -v -f $srcdir/known_failures)"

# run, logging the output
for prog in $progs; do
    engine="$(echo $prog | cut -d'/' -f3)"
    binary="$(echo $prog | cut -d'/' -f4)"
    run "$engine" "$binary"
done

# group by benchmark and compare logs
failed=0
for bench in $(find "$logdir" -type f -exec basename {} \; | stem_bench | sort | uniq); do
    logs=( $(find "$logdir" -name $bench[.-]*) )
    for i in $(seq 2 ${#logs[@]}) ; do
        cmp ${logs[i-2]} ${logs[i-1]} || failed=1
    done
done
[ $failed -eq 0 ] && echo "OK" || echo "FAIL"
